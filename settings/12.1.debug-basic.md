# 12. Debug
## 12.1. Basic settings

Настройки **Debug** в W3 Total Cache предоставляют мощные инструменты для диагностики кэширования, позволяя анализировать работу модулей (**Page Cache**, **Minify**, **Database Cache**, **Object Cache**, **CDN**, **FSD CDN**, **Reverse Proxy**) через HTML-комментарии и логи очистки (**Purge Logs**, PRO). Включите **Debug mode** для проблемных модулей и используйте **Purge Logs** для отслеживания очистки кэша, но отключайте после диагностики, чтобы избежать снижения производительности и утечки данных. Комбинируйте с **Page Cache**, **Minify**, **CDN**, и **Browser Cache** для устранения проблем. Тестируйте в **Preview Mode** (Performance → General Settings) и очищайте кэш после изменений (Performance → Dashboard → Empty All Caches).

---

### 1. Debug mode
- **Описание**: Активирует режим отладки для выбранных модулей кэширования, добавляя подробную информацию в HTML-комментарии в конце каждой страницы.
- **Назначение**: Позволяет анализировать работу кэширования, проверять, какие модули активны, и выявлять проблемы (например, отсутствие кэша, конфликты).
- **Технические детали**:
  - Доступные опции:
    - **Page Cache**: Отображает информацию о кэшировании страниц (например, метод кэширования, время создания кэша).
    - **Minify**: Показывает данные о минификации CSS/JS (например, список минифицированных файлов, ошибки).
    - **Database Cache**: Выводит статистику кэширования запросов к базе данных (например, хиты/промахи кэша).
    - **Object Cache**: Отображает информацию о кэшировании объектов (например, какие объекты кэшируются, время жизни).
    - **CDN**: Показывает данные о доставке файлов через CDN (например, переписанные URL, статус синхронизации).
    - **FSD CDN**: Выводит информацию о Full Site Delivery через CDN (PRO-версия, например, кэширование HTML).
    - **Reverse Proxy**: Отображает данные о работе Varnish или другого прокси (например, статус PURGE-запросов).
  - Комментарии добавляются в HTML в формате `<!-- W3 Total Cache: [Module] debug info: ... -->`.
  - Пример комментария для Page Cache:
    ```html
    <!-- W3 Total Cache: Page cache debug info:
    Rendering time: 0.123 sec
    Engine: Disk: Enhanced
    Cache key: example.com/about
    Creation time: 2025-04-18 12:00:00
    -->
    ```
  - Комментарии видны всем пользователям при просмотре исходного кода, что может раскрывать структуру сайта.
- **Пример**:
  - Включён **Debug mode: Page Cache**:
    - Страница `/about` содержит комментарий с информацией о кэше (время создания, метод).
    - Если кэш не срабатывает, комментарий покажет причину (например, "Cache not hit: dynamic page").
  - Включён **Debug mode: Minify**:
    - Комментарий показывает список минифицированных файлов и ошибки, если они есть (например, "Failed to minify: syntax error").
- **Рекомендация**:
  - Включите только для модулей, которые нужно диагностировать (например, **Page Cache** для проверки кэширования страниц).
  - Используйте на тестовом сайте или во внепиковое время, чтобы минимизировать влияние на производительность.
  - Отключите после завершения диагностики (Performance → Debug → Uncheck all).
- **Осторожно**:
  - HTML-комментарии увеличивают размер страницы (на 1–10 КБ), замедляя загрузку.
  - Публичные комментарии могут раскрывать чувствительные данные (пути, IP, конфигурацию).
  - Не используйте на продакшен-сайте с высоким трафиком.
  - Проверьте комментарии в Chrome DevTools (View Source) для анализа.

### 2. Purge Logs ★ PRO
- **Описание**: Включает ведение логов очистки кэша для выбранных модулей (Page Cache, Database Cache, Object Cache), фиксируя события и их причины.
- **Назначение**: Помогает отслеживать, когда и почему кэш очищается, для диагностики избыточной очистки или проблем с плагинами.
- **Технические детали**:
  - Доступные опции:
    - **Page Cache Purge Log**: Логирует события очистки кэша страниц (например, при обновлении поста, комментария).
    - **Database Cache Purge Log**: Фиксирует очистку кэша базы данных (например, при изменении настроек).
    - **Object Cache Purge Log**: Записывает события очистки кэша объектов (например, при сбросе транзиентов).
  - Логи хранятся в файлах (обычно в `wp-content/cache/log/`) и доступны в админ-панели (Performance → Debug).
  - Пример записи в логе для Page Cache:
    ```
    2025-04-18 12:05:00: Page cache purged
    Trigger: Post updated (ID: 123)
    URL: https://example.com/post-title
    Initiator: WordPress Core
    ```
  - Требует PRO-версии W3 Total Cache.
  - Логи могут занимать место на диске, особенно на сайтах с частыми обновлениями.
- **Пример**:
  - Включён **Page Cache Purge Log**:
    - Обновление поста вызывает запись: "Page cache purged for /post-title by user ID 1".
    - Плагин вызывает массовую очистку: Лог показывает "Full cache purge by Plugin X".
  - Включён **Database Cache Purge Log**:
    - Изменение настроек темы фиксируется как "Database cache flushed by Theme Switch".
- **Рекомендация**:
  - Включите для диагностики избыточной очистки кэша (например, если кэш сбрасывается слишком часто).
  - Используйте для анализа действий плагинов или пользователей, инициирующих очистку.
  - Регулярно проверяйте логи в админ-панели и очищайте старые записи.
- **Осторожно**:
  - Логи могут увеличивать использование диска, особенно на активных сайтах.
  - Не оставляйте включённым на продакшене без необходимости.
  - Убедитесь, что папка `wp-content/cache/log/` защищена от публичного доступа (например, через `.htaccess`).

---

## Дополнительные аспекты

- **Интеграция с другими настройками**:
  - **Page Cache**: Debug mode показывает, срабатывает ли кэш страниц и какой метод используется (Disk: Enhanced, Memcached).
  - **Minify**: Помогает выявить ошибки минификации (например, синтаксические ошибки в CSS/JS).
  - **Database Cache**: Отображает статистику хитов/промахов, полезно для оптимизации запросов.
  - **Object Cache**: Показывает, какие объекты кэшируются и как часто обновляются.
  - **CDN**: Указывает, какие файлы доставляются через CDN и синхронизированы ли они.
  - **FSD CDN**: Диагностирует кэширование HTML через CDN (PRO).
  - **Reverse Proxy**: Проверяет PURGE-запросы к Varnish и их успешность.
  - **Browser Cache**: Debug может показать, как кэш браузера взаимодействует с серверным кэшем.
  - **Security Headers**: Убедитесь, что комментарии Debug не раскрывают данные, защищённые заголовками (например, пути к файлам).
- **Влияние на производительность**:
  - Debug mode увеличивает размер HTML (на 1–10 КБ на страницу) и время обработки запросов.
  - Purge Logs создают дополнительную нагрузку на диск при записи событий.
  - Используйте только на тестовых средах или временно на продакшене.
- **Альтернативы**:
  - Используйте логи сервера (Apache/Nginx) для анализа запросов.
  - Применяйте инструменты мониторинга (New Relic, Query Monitor) для диагностики без Debug.
  - Проверяйте кэширование через Chrome DevTools (Network, заголовки `X-Cache`).

---

## Примеры использования

- **Блог на shared-хостинге**:
  - Настройка: Включите **Debug mode: Page Cache** и **Page Cache Purge Log** (PRO).
  - Проблема: Страницы не кэшируются.
  - Результат: Комментарий показывает "Cache not hit: dynamic page". Лог указывает на плагин, вызывающий очистку при каждом запросе. Решение: Настроить исключения в плагине.

- **WooCommerce на VPS**:
  - Настройка: Включите **Debug mode: CDN, Database Cache** и **Database Cache Purge Log** (PRO).
  - Проблема: Изображения не доставляются через CDN, медленные запросы к БД.
  - Результат: Комментарий показывает, что URL не переписаны на CDN (ошибка в API-ключе). Лог указывает на частую очистку Database Cache плагином WooCommerce. Решение: Исправить API-ключ, настроить исключения.

- **Новостной сайт на выделенном сервере**:
  - Настройка: Включите **Debug mode: Reverse Proxy, Page Cache** и **Page Cache Purge Log** (PRO).
  - Проблема: Varnish не кэширует страницы.
  - Результат: Комментарий показывает "PURGE request failed: 405 Not Allowed". Лог указывает на массовую очистку при обновлении постов. Решение: Исправить VCL для PURGE, настроить выборочную очистку.

---

## Рекомендации по настройке

| Настройка | Рекомендация | Примечание |
| --- | --- | --- |
| Debug mode | Включить временно | Выберите только нужные модули; отключайте после диагностики. |
| Page Cache | Включить для проверки кэша | Проверяйте метод и причины промахов. |
| Minify | Включить при ошибках минификации | Ищите синтаксические ошибки в CSS/JS. |
| Database Cache | Включить для анализа БД | Проверяйте хиты/промахи запросов. |
| Object Cache | Включить для объектов | Анализируйте транзиенты и обновления. |
| CDN | Включить для проверки URL | Убедитесь в переписывании URL. |
| FSD CDN | Включить для HTML (PRO) | Проверяйте кэширование страниц. |
| Reverse Proxy | Включить для Varnish | Диагностируйте PURGE-запросы. |
| Purge Logs | Включить (PRO) | Используйте для анализа очистки; очищайте старые логи. |

- **Настройка**:
  - Включите только те модули, которые нужно диагностировать, чтобы минимизировать влияние на производительность.
  - Используйте **Purge Logs** для выявления плагинов или действий, вызывающих избыточную очистку.
  - Проверяйте HTML-комментарии через "View Source" в браузере или Chrome DevTools.
- **Совместимость**:
  - Проверьте, не конфликтуют ли другие плагины кэширования (WP Rocket, LiteSpeed Cache) с Debug.
  - Убедитесь, что настройки **Page Cache**, **Minify**, или **CDN** корректны перед включением Debug.
- **Тестирование**:
  - Используйте **Preview Mode** (Performance → General Settings) для проверки без влияния на продакшен.
  - Проверяйте комментарии и логи после каждого изменения (например, обновления поста, очистки кэша).
  - Очистите кэш после отключения Debug (Performance → Dashboard → Empty All Caches).
- **Безопасность**:
  - Избегайте использования Debug на продакшене, так как комментарии раскрывают внутреннюю информацию.
  - Защитите папку `wp-content/cache/log/` через `.htaccess` (например, `Deny from all`).
  - Проверьте **Security Headers** (например, `Content-Security-Policy`) на влияние Debug-комментариев.
- **Мониторинг**:
  - Используйте [Query Monitor](https://wordpress.org/plugins/query-monitor/) для анализа запросов БД и объектов.
  - Проверяйте производительность с [GTmetrix](https://gtmetrix.com) или [Pingdom](https://tools.pingdom.com) после отключения Debug.

---

### Дополнительные советы

- **Debug mode**: Включайте по одному модулю для минимизации размера комментариев.
- **Purge Logs**: Регулярно очищайте логи через админ-панель, чтобы освободить место.
- **Диагностика**: Используйте Chrome DevTools (Network, Console) для проверки HTTP-запросов и ошибок.
- **Безопасность**: Проверьте комментарии на наличие чувствительных данных (например, IP Varnish, пути к файлам).
- **PRO-версия**: Рассмотрите покупку PRO для доступа к **Purge Logs** при частых проблемах с очисткой.
