# 5. Database Cache (Кэширование базы данных)
## 5.1. [Basic settings](./5.1.database-basic.md)
## 5.2. Advanced settings

Настройки **Database Cache** в W3 Total Cache оптимизируют производительность WordPress, кэшируя запросы к базе данных. Включение полезно для сайтов с высокой нагрузкой (WooCommerce, порталы), но избыточно при использовании **Object Cache** или на простых сайтах. На shared-хостинге используйте **Disk** и включите **Don’t Cache Queries for Logged-in Users** для персонализированного контента. На VPS предпочтите **Memcached/Redis** и настройте короткий **Maximum Lifetime** (180–300 секунд) для актуальности данных. Тестируйте изменения в **Preview Mode** (Performance → General Settings) и очищайте кэш после настройки (Performance → Dashboard → Empty All Caches).


## 1. General

### 1.1. Don’t Cache Queries for Logged-in Users

- **Описание**: Отключает кэширование запросов к базе данных для авторизованных пользователей.
- **Назначение**: Обеспечивает актуальность данных для пользователей, вошедших в систему, сохраняя стандартное поведение WordPress (например, отображение персонализированных данных).
- **Пример**: Пользователь в личном кабинете `example.com/my-account/` видит актуальные данные корзины, а не кэшированные.
- **Рекомендация**:
    - Включите для сайтов с персонализированным контентом (WooCommerce, форумы, личные кабинеты).
    - Отключите, если авторизованные пользователи составляют большую часть трафика и кэш безопасен.
- **Осторожно**:
    - Включение увеличивает нагрузку на сервер для авторизованных пользователей.
    - Проверьте, не нарушает ли отключение функциональность для неавторизованных пользователей.

---

## 2. Advanced

### 2.1. Maximum Lifetime of Cache Objects

- **Описание**: Устанавливает максимальный срок жизни кэшированных запросов (в секундах).
- **Значение по умолчанию**: 180 секунд (3 минуты).
- **Назначение**: Определяет, как долго кэшированные результаты запросов остаются действительными перед их удалением.
- **Пример**: При значении 180 секунд кэш запроса для страницы `example.com/shop/` обновляется каждые 3 минуты.
- **Рекомендация**:
    - Установите 180–300 секунд для сайтов с часто обновляемым контентом (новости, магазины).
    - Увеличьте до 3600 секунд (1 час) для статичных сайтов, чтобы уменьшить нагрузку.
- **Осторожно**:
    - Слишком долгий срок (например, 86400 секунд) может привести к показу устаревших данных.
    - Слишком короткий срок увеличивает обращения к базе данных.

### 2.2. Garbage Collection Interval

- **Описание**: Устанавливает, как часто удаляется устаревший кэш (в секундах), если используется метод **Disk**.
- **Значение по умолчанию**: 3600 секунд (1 час).
- **Пример**: При значении 3600 секунд плагин очищает старый кэш каждый час, освобождая место на диске.
- **Рекомендация**:
    - Оставьте 3600 секунд для большинства сайтов.
    - Уменьшите до 1800 секунд для занятых сайтов с ограниченным дисковым пространством.
- **Осторожно**:
    - Слишком частая очистка (например, 300 секунд) увеличивает нагрузку на сервер.
    - Не влияет на методы Memcached/Redis.

### 2.3. Never Cache the Following Pages

- **Описание**: Указывает страницы или шаблоны URL, для которых запросы к базе данных не кэшируются.
- **Пример**: Добавьте `/cart/*`, `/checkout/*` для WooCommerce, чтобы исключить корзину и оформление заказа.
- **Рекомендация**:
    - Укажите динамические страницы: `/wp-admin/*`, `/cart/*`, `/my-account/*`.
    - Используйте регулярные выражения для точности (например, `*/feed/*`).
- **Осторожно**:
    - Проверьте шаблоны, чтобы не исключить важные страницы.
    - См. FAQ W3 Total Cache для примеров регулярных выражений.

### 2.4. Ignored Query Stems

- **Описание**: Указывает префиксы SQL-запросов, которые не кэшируются.
- **Пример**: Добавление `gdsr_`, `wp_rg_`, `_wp_session_`, `_wc_session_` исключает запросы, связанные с плагинами (например, GD Star Rating, Gravity Forms, WooCommerce).
- **Назначение**: Предотвращает кэширование запросов, которые должны быть динамическими.
- **Рекомендация**:
    - Оставьте значения по умолчанию (`gdsr_`, `wp_rg_`, `_wp_session_`, `_wc_session_`).
    - Добавьте префиксы для других плагинов, если они генерируют динамические запросы (узнать можно в режиме отладки).
- **Осторожно**:
    - Префикс базы данных (например, `wp_`) автоматически заменяется текущим, заданным в `wp-config.php`.
    - Неправильные префиксы могут исключить важные запросы.

### 2.5. Reject Query Words

- **Описание**: Указывает ключевые слова или регулярные выражения SQL-запросов, которые не кэшируются.
- **Пример**: Список по умолчанию (`insert`, `delete`, `update`, `replace`, `create`, `alter`, `show`, `set`, `autoload = 'yes'`, `sql_calc_found_rows`, `found_rows()`) исключает запросы, изменяющие базу данных или требующие свежести.
- **Назначение**: Предотвращает кэширование запросов, которые должны выполняться в реальном времени.
- **Рекомендация**:
    - Оставьте значения по умолчанию, так как они покрывают большинство случаев.
    - Добавьте специфические слова, если используете кастомные запросы.
- **Осторожно**:
    - Неправильные выражения могут исключить нужные запросы.
    - Используйте режим отладки для анализа запросов.

### 2.6. Reject Constants

- **Описание**: Отключает кэширование, если определены указанные PHP-константы.
- **Пример**: Список по умолчанию (`APP_REQUEST`, `DOING_CRON`, `DONOTCACHEDB`, `SHORTINIT`, `XMLRPC_REQUEST`) предотвращает кэширование во время cron-задач или XML-RPC запросов.
- **Назначение**: Обеспечивает свежесть данных в специфических сценариях.
- **Рекомендация**: Оставьте значения по умолчанию.
- **Осторожно**: Добавление лишних констант может отключить кэширование в неподходящих случаях.

### 2.7. Enable for WP-CLI

- **Описание**: Включает кэширование запросов при использовании WP-CLI (интерфейса командной строки WordPress).
- **Пример**: Если включено, команда `wp post list` будет использовать кэшированные запросы, ускоряя выполнение.
- **Рекомендация**:
    - Включите, если активно используете WP-CLI для автоматизации задач.
    - Отключите, если WP-CLI используется редко или требует актуальных данных.
- **Осторожно**: Кэширование может повлиять на результаты команд WP-CLI, если данные устарели.

---

## 3. Purge via WP Cron

### 3.1. Enable WP-Cron Event

- **Описание**: Включает автоматическую очистку кэша базы данных через WP-Cron.
- **Пример**: Включение создаёт задачу WP-Cron для периодической очистки кэша.
- **Рекомендация**:
    - Включите на shared-хостинге для автоматической очистки.
    - Используйте системный cron (`wp w3tc flush db`) на VPS для большей надёжности.
- **Осторожно**: WP-Cron может быть ненадёжным на сайтах с низким трафиком.

### 3.2. Start Time

- **Описание**: Устанавливает время начала выполнения задачи WP-Cron.
- **Значение по умолчанию**: 12:00 AM.
- **Пример**: Установка 12:00 AM запускает очистку в полночь.
- **Рекомендация**: Выберите время с низкой нагрузкой (ночь).
- **Осторожно**: Если время прошло, задача запустится на следующий день.

### 3.3. Interval

- **Описание**: Устанавливает интервал выполнения задачи WP-Cron.
- **Значение по умолчанию**: Hourly (каждый час).
- **Пример**: Установка "Hourly" очищает кэш каждый час.
- **Рекомендация**:
    - Используйте "Hourly" для занятых сайтов.
    - Увеличьте до "Daily" для слабых серверов.
- **Осторожно**: Частый интервал увеличивает нагрузку.

---

## Рекомендации для раздела Database Cache

| Настройка | Рекомендация |
| --- | --- |
| Database Cache: Enable | Включить для сайтов с высокой нагрузкой, отключить при использовании Object Cache |
| Database Cache Method | **Disk** для shared-хостинга, **Memcached/Redis** для VPS |
| Don’t Cache Queries for Logged-in Users | Включить для персонализированного контента |
| Maximum Lifetime of Cache Objects | 180–300 секунд для динамичных сайтов, 3600 секунд для статичных |
| Garbage Collection Interval | 3600 секунд, 1800 секунд для занятых сайтов |
| Never Cache the Following Pages | Указать `/wp-admin/*`, `/cart/*` |
| Ignored Query Stems | Оставить по умолчанию, добавить плагин-специфичные |
| Reject Query Words | Оставить по умолчанию |
| Reject Constants | Оставить по умолчанию |
| Enable for WP-CLI | Включить при активном использовании WP-CLI |
| Enable WP-Cron Event | Включить на shared-хостинге |
| WP-Cron Start Time | Ночное время |
| WP-Cron Interval | Hourly для занятых сайтов, Daily для слабых |

---

## Примеры использования

- **Блог на shared-хостинге**:

    - **Database Cache**: Отключите, если блог простой (5–10 запросов на страницу).
    - **Database Cache Method**: Если включено, используйте **Disk**.
    - **Don’t Cache Queries for Logged-in Users**: Включите.
    - **Maximum Lifetime**: 3600 секунд.
    - **Never Cache Pages**: Укажите `/wp-admin/*`.
    - Результат: Экономия ресурсов на статичных сайтах.

- **WooCommerce на VPS**:

    - **Database Cache**: Включите для множества запросов (товары, фильтры).
    - **Database Cache Method**: **Redis** для скорости.
    - **Don’t Cache Queries for Logged-in Users**: Включите.
    - **Maximum Lifetime**: 180 секунд.
    - **Never Cache Pages**: Укажите `/cart/*`, `/checkout/*`.
    - **Ignored Query Stems**: Оставьте `_wc_session_`.
    - Результат: Ускорение страниц магазина на 20–50%.

- **Новостной сайт на выделенном сервере**:

    - **Database Cache**: Включите для сложных запросов (новости, категории).
    - **Database Cache Method**: **Memcached**.
    - **Maximum Lifetime**: 300 секунд.
    - **Garbage Collection**: 3600 секунд.
    - **Reject Query Words/Constants**: Оставьте по умолчанию.
    - Результат: Быстрая загрузка динамического контента.

---

### Дополнительные советы

- **Object Cache**: Предпочтите **Object Cache** вместо Database Cache, если доступны Memcached/Redis, так как оно более эффективно.
- **Оптимизация базы данных**: Используйте WP-Optimize для очистки базы и добавьте индексы для часто запрашиваемых таблиц.
- **Мониторинг**: Применяйте Query Monitor или New Relic для анализа запросов и эффекта кэширования.
- **Shared-хостинг**: Будьте осторожны с **Disk** на слабых серверах, так как I/O может замедлить сайт.
- **Режим отладки**: Включите debug mode в W3 Total Cache, чтобы выявить запросы для исключения в **Ignored Query Stems**.
