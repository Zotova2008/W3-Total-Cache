# 7. Browser Cache (Кэширование в браузере)
## 7.1. [Basic settings](./7.1.browser-basic.md)
## 7.2. Advanced settings

Настройки **Browser Cache** оптимизируют загрузку WordPress-сайта, кэшируя статические файлы, сжимая данные и усиливая безопасность. Включите **Browser Cache: Enable**, настройте заголовки (`Expires`, `Cache-Control`) и сжатие (Gzip/Brotli) для всех типов файлов. Для динамичных страниц используйте короткий срок кэширования (3600–7200 секунд), для статичных — долгий (31536000 секунд). Настройте **Security Headers** и **Feature-Policy** для защиты от атак. Тестируйте в **Preview Mode** (Performance → General Settings) и очищайте кэш после настройки (Performance → Dashboard → Empty All Caches).

---

## 1. General

### 1.1. Set Last-Modified Header
- **Описание**: Добавляет заголовок `Last-Modified` для поддержки ответа `304 Not Modified`.
- **Назначение**: Позволяет браузеру проверить, изменился ли файл, и использовать кэшированную версию, если он не изменился.
- **Пример**: Браузер запрашивает `logo.png` с `If-Modified-Since`, сервер отвечает `304 Not Modified`, экономя трафик.
- **Рекомендация**: Включите для всех типов файлов, чтобы снизить нагрузку на сервер.
- **Осторожно**: Убедитесь, что сервер правильно обрабатывает `Last-Modified`.

### 1.2. Set Expires Header
- **Описание**: Добавляет заголовок `Expires` для указания срока кэширования.
- **Назначение**: Сообщает браузеру, как долго хранить файл перед повторным запросом.
- **Пример**: `Expires: Thu, 18 Apr 2026 12:00:00 GMT` для `style.css` позволяет кэшировать файл на год.
- **Рекомендация**: Включите для статичных файлов (CSS, JS, изображения).
- **Осторожно**: Настройте подходящий срок в блоках **CSS & JS**, **HTML & XML**, **Media & Other Files**.

### 1.3. Set Cache Control Header
- **Описание**: Добавляет заголовки `Pragma` и `Cache-Control` для управления кэшированием.
- **Назначение**: Указывает браузерам и прокси-серверам, как кэшировать файлы (например, `public, max-age=31536000`).
- **Пример**: `Cache-Control: public, max-age=31536000` для `script.js` кэширует файл на год.
- **Рекомендация**: Включите с политикой `cache with max-age` для статичных файлов.
- **Осторожно**: Для динамичных страниц (HTML) используйте короткий `max-age`.

### 1.4. Set Entity Tag (ETag)
- **Описание**: Добавляет заголовок `ETag` для идентификации версии файла.
- **Назначение**: Позволяет браузеру проверить, изменился ли файл, используя `If-None-Match`.
- **Пример**: `ETag: "abc123"` для `image.jpg` позволяет вернуть `304 Not Modified`.
- **Рекомендация**: Включите для статичных файлов, но отключите на серверах с высокой нагрузкой, если ETag создаёт издержки.
- **Осторожно**: На некоторых серверах ETag может замедлить обработку.

### 1.5. Set W3 Total Cache Header
- **Описание**: Добавляет заголовок `X-W3TC` для идентификации оптимизированных файлов.
- **Назначение**: Помогает в отладке, показывая, что файл обработан W3 Total Cache.
- **Пример**: `X-W3TC: Minified` для минифицированного `style.css`.
- **Рекомендация**: Включите для отладки, отключите в продакшене для уменьшения размера ответа.
- **Осторожно**: Не влияет на производительность, но увеличивает размер заголовков.

### 1.6. Enable HTTP (Gzip) Compression
- **Описание**: Включает сжатие Gzip для текстовых файлов.
- **Назначение**: Уменьшает размер CSS, JS, HTML, сокращая время загрузки.
- **Пример**: `style.css` (50 КБ) сжимается до 10 КБ, ускоряя загрузку на 80%.
- **Рекомендация**: Включите для всех текстовых файлов, если сервер поддерживает Gzip.
- **Осторожно**: Проверьте поддержку на сервере (Apache, Nginx).

### 1.7. Enable HTTP (Brotli) Compression
- **Описание**: Включает сжатие Brotli для текстовых файлов.
- **Назначение**: Более эффективное сжатие, чем Gzip, для современных браузеров.
- **Пример**: `script.js` (50 КБ) сжимается до 8 КБ с Brotli.
- **Рекомендация**: Включите, если сервер и браузеры поддерживают Brotli (проверьте через GTmetrix).
- **Осторожно**: Требует модуль Brotli на сервере.

### 1.8. Prevent Caching of Objects After Settings Change
- **Описание**: Добавляет query string к файлам при изменении настроек.
- **Назначение**: Обеспечивает загрузку новых версий файлов после изменения настроек кэширования.
- **Пример**: `style.css?ver=123` становится `style.css?ver=124` после изменения настроек.
- **Рекомендация**: Включите для автоматического обновления кэшированных файлов.
- **Осторожно**: Может конфликтовать с CDN; синхронизируйте настройки.

### 1.9. Remove Query Strings from Static Resources
- **Описание**: Удаляет query string (`?ver=1.1`) из URL статичных файлов.
- **Назначение**: Улучшает кэширование на некоторых прокси-серверах.
- **Пример**: `style.css?ver=1.1` становится `style.css`.
- **Рекомендация**: Включите, если прокси-серверы (например, старые версии Squid) не кэшируют файлы с query string.
- **Осторожно**: Может нарушить версионирование; используйте альтернативные методы (например, изменение имени файла).

### 1.10. Prevent Caching Exception List
- **Описание**: Указывает URL, к которым не добавляется query string для предотвращения кэширования.
- **Назначение**: Исключает динамичные файлы из автоматического добавления query string.
- **Пример**: `/wp-admin/*` исключается, чтобы избежать проблем в админке.
- **Рекомендация**: Добавьте динамичные URL (например, `/wp-admin/*`, `/cart/*`).
- **Осторожно**: Используйте регулярные выражения осторожно (см. FAQ W3 Total Cache).

### 1.11. Don't Set Cookies for Static Files
- **Описание**: Удаляет заголовок `Set-Cookie` для статичных файлов.
- **Назначение**: Улучшает кэширование на прокси и в браузерах.
- **Пример**: `image.jpg` возвращается без `Set-Cookie`, позволяя кэшировать его.
- **Рекомендация**: Включите для всех статичных файлов.
- **Осторожно**: Убедитесь, что cookies не нужны для этих файлов.

### 1.12. Do Not Process 404 Errors for Static Objects with WordPress
- **Описание**: Позволяет веб-серверу обрабатывать 404 ошибки для статичных файлов, минуя WordPress.
- **Назначение**: Снижает нагрузку на сервер, передавая обработку 404 ошибок Apache/Nginx.
- **Пример**: Запрос к несуществующему `missing.jpg` возвращает 404 от Nginx, а не WordPress.
- **Рекомендация**: Включите для снижения нагрузки.
- **Осторожно**: Может вызвать 404 для динамичных файлов от плагинов; добавьте их в исключения.

### 1.13. 404 Error Exception List
- **Описание**: Указывает URL, для которых 404 ошибки обрабатываются WordPress.
- **Пример**: По умолчанию: `robots\.txt`, `[a-z0-9_\-]*sitemap[a-z0-9_\.\-]*\.(xml|xsl|html)(\.gz)?` для защиты sitemap и robots.txt.
- **Рекомендация**: Добавьте URL динамичных файлов от плагинов (например, `/sitemap.xml`).
- **Осторожно**: Проверьте регулярные выражения.

### 1.14. Rewrite URL Structure of Objects
- **Описание**: Создаёт уникальные URI для файлов, защищённых от кэширования.
- **Назначение**: Обеспечивает уникальность URL для обхода кэширования браузером.
- **Пример**: `style.css` переписывается как `cache/style-123.css`.
- **Рекомендация**: Включите при проблемах с кэшированием.
- **Осторожно**: Может усложнить отладку; используйте с осторожностью.

---

## 2. CSS & JS

### 2.1. Set Last-Modified Header
- **Рекомендация**: Включите для поддержки `304 Not Modified`.

### 2.2. Set Expires Header
- **Рекомендация**: Включите.

### 2.3. Expires Header Lifetime
- **Значение по умолчанию**: 31536000 секунд (1 год).
- **Пример**: CSS/JS кэшируются на год.
- **Рекомендация**: Оставьте 31536000 секунд для статичных файлов; используйте версионирование для обновлений.
- **Осторожно**: Короткий срок увеличивает запросы.

### 2.4. Set Cache Control Header
- **Рекомендация**: Включите с политикой `cache with max-age`.

### 2.5. Cache Control Policy
- **Значение по умолчанию**: `cache with max-age ("public, max-age=EXPIRES_SECONDS")`.
- **Рекомендация**: Оставьте по умолчанию для CSS/JS.
- **Осторожно**: Прокси могут игнорировать другие политики.

### 2.6. Set Entity Tag (ETag)
- **Рекомендация**: Включите, но отключите при высокой нагрузке.

### 2.7. Set W3 Total Cache Header
- **Рекомендация**: Включите для отладки.

### 2.8. Enable HTTP (Gzip) Compression
- **Рекомендация**: Включите.

### 2.9. Enable HTTP (Brotli) Compression
- **Рекомендация**: Включите, если поддерживается.

### 2.10. Prevent Caching of Objects After Settings Change
- **Рекомендация**: Включите.

### 2.11. Remove Query Strings from Static Resources
- **Рекомендация**: Включите при проблемах с прокси.

### 2.12. Disable Cookies for Static Files
- **Рекомендация**: Включите.

---

## 3. HTML & XML

### 3.1. Set Last-Modified Header
- **Рекомендация**: Включите.

### 3.2. Set Expires Header
- **Рекомендация**: Включите.

### 3.3. Expires Header Lifetime
- **Значение по умолчанию**: 3600 секунд (1 час).
- **Пример**: HTML-страницы кэшируются на час.
- **Рекомендация**: Установите 3600–7200 секунд для динамичных страниц.
- **Осторожно**: Долгий срок может показать устаревший контент.

### 3.4. Set Cache Control Header
- **Рекомендация**: Включите.

### 3.5. Cache Control Policy
- **Рекомендация**: Оставьте `cache with max-age`.

### 3.6. Set Entity Tag (ETag)
- **Рекомендация**: Включите.

### 3.7. Set W3 Total Cache Header
- **Рекомендация**: Включите для отладки.

### 3.8. Enable HTTP (Gzip) Compression
- **Рекомендация**: Включите.

### 3.9. Enable HTTP (Brotli) Compression
- **Рекомендация**: Включите, если поддерживается.

---

## 4. Media & Other Files

### 4.1. Set Last-Modified Header
- **Рекомендация**: Включите.

### 4.2. Set Expires Header
- **Рекомендация**: Включите.

### 4.3. Expires Header Lifetime
- **Значение по умолчанию**: 31536000 секунд (1 год).
- **Рекомендация**: Оставьте для изображений, видео.

### 4.4. Set Cache Control Header
- **Рекомендация**: Включите.

### 4.5. Cache Control Policy
- **Рекомендация**: Оставьте `cache with max-age`.

### 4.6. Set Entity Tag (ETag)
- **Рекомендация**: Включите.

### 4.7. Set W3 Total Cache Header
- **Рекомендация**: Включите для отладки.

### 4.8. Enable HTTP (Gzip) Compression
- **Рекомендация**: Включите для текстовых медиафайлов.

### 4.9. Enable HTTP (Brotli) Compression
- **Рекомендация**: Включите, если поддерживается.

### 4.10. Prevent Caching of Objects After Settings Change
- **Рекомендация**: Включите.

### 4.11. Remove Query Strings from Static Resources
- **Рекомендация**: Включите при проблемах с прокси.

### 4.12. Disable Cookies for Static Files
- **Рекомендация**: Включите.

---

## 5. Security Headers

### 5.1. Use Cookies to Store Session IDs
- **Значение по умолчанию**: Default.
- **Рекомендация**: Оставьте по умолчанию для защиты от передачи сессий в URL.
- **Осторожно**: Проверьте совместимость с плагинами.

### 5.2. Access Session Cookies Through the HTTP Only
- **Значение по умолчанию**: Default.
- **Рекомендация**: Оставьте для защиты от XSS-атак.
- **Осторожно**: Может ограничить JavaScript-доступ к cookies.

### 5.3. Send Session Cookies Only to Secure Connections
- **Значение по умолчанию**: Default.
- **Рекомендация**: Оставьте для HTTPS-сайтов.
- **Осторожно**: Требует SSL.

### 5.4. HTTP Strict Transport Security (HSTS)
- **Описание**: HTTP Strict Transport Security (HSTS) — это HTTP-заголовок, который заставляет браузеры использовать только защищённые соединения (HTTPS) для доступа к сайту, предотвращая использование HTTP. Это помогает защитить от атак типа "человек посередине" (man-in-the-middle, MITM), перехвата данных через cookies или ссылки, а также устраняет возможность игнорирования предупреждений о проблемах с SSL/TLS (например, недействительных сертификатах).
- **Назначение**:
  - Защищает пользователей, обеспечивая доступ к сайту только через HTTPS.
  - Предотвращает утечку сессионных данных через незащищённые соединения.
  - Устраняет возможность обхода SSL-предупреждений, повышая доверие к сайту.
- **Технические детали**:
  - Заголовок: `Strict-Transport-Security`.
  - Формат: `max-age=<seconds>[; includeSubDomains][; preload]`.
  - `max-age`: Указывает, сколько секунд браузер должен использовать HTTPS для сайта.
  - `includeSubDomains`: Применяет HSTS ко всем поддоменам (например, `sub.example.com`).
  - `preload`: Разрешает включение сайта в список HSTS Preload, встроенный в браузеры, для принудительного HTTPS даже при первом посещении.
  - Требует действующий SSL/TLS-сертификат на сервере.
- **Директивы**:
  - **`max-age=EXPIRES_SECONDS`** (по умолчанию):
    - Указывает браузеру использовать HTTPS для всех запросов к сайту в течение заданного времени (`EXPIRES_SECONDS`, обычно 31536000 секунд или 1 год).
    - Применяется только к основному домену (например, `example.com`), без поддоменов.
    - **Пример**: `Strict-Transport-Security: max-age=31536000` заставляет браузер использовать HTTPS для `example.com` в течение года.
    - **Рекомендация**: Используйте для сайтов, где поддомены не требуют HSTS (например, если поддомены работают через HTTP или не существуют).
    - **Осторожно**: Убедитесь, что HTTPS настроен корректно; ошибки могут заблокировать доступ к сайту.
  - **`max-age=EXPIRES_SECONDS; preload`**:
    - Добавляет сайт в список HSTS Preload, встроенный в браузеры (Chrome, Firefox и др.), что заставляет использовать HTTPS даже при первом посещении, до получения заголовка.
    - Требует регистрации сайта на [hstspreload.org](https://hstspreload.org).
    - **Пример**: `Strict-Transport-Security: max-age=31536000; preload` включает `example.com` в preload-список, обеспечивая HTTPS с первого запроса.
    - **Рекомендация**: Используйте для крупных сайтов с долгосрочной HTTPS-политикой, готовых к строгим требованиям preload (например, действующий сертификат, HTTPS на всех поддоменах).
    - **Осторожно**: Неправильная настройка или удаление из preload-списка может заблокировать доступ к сайту на месяцы. Требуется регистрация и соблюдение условий preload.
  - **`max-age=EXPIRES_SECONDS; includeSubDomains`**:
    - Применяет HSTS ко всем поддоменам домена (например, `blog.example.com`, `shop.example.com`).
    - **Пример**: `Strict-Transport-Security: max-age=31536000; includeSubDomains` заставляет использовать HTTPS для `example.com` и всех его поддоменов.
    - **Рекомендация**: Используйте, если все поддомены поддерживают HTTPS (например, для интернет-магазинов с поддоменами для блога, корзины).
    - **Осторожно**: Убедитесь, что все поддомены имеют действующие SSL-сертификаты; иначе доступ к поддоменам будет заблокирован.
  - **`max-age=EXPIRES_SECONDS; includeSubDomains; preload`**:
    - Комбинирует `includeSubDomains` и `preload`, применяя HSTS ко всем поддоменам и добавляя сайт в preload-список.
    - **Пример**: `Strict-Transport-Security: max-age=31536000; includeSubDomains; preload` обеспечивает HTTPS для `example.com` и всех поддоменов с первого посещения.
    - **Рекомендация**: Используйте для сайтов с высокой степенью безопасности, где все поддомены поддерживают HTTPS и вы готовы к регистрации в preload-список.
    - **Осторожно**: Самая строгая директива; ошибки в настройке (например, отсутствие HTTPS на поддомене) могут заблокировать весь сайт и поддомены. Требуется регистрация на hstspreload.org.
- **Пример**:
  - Сайт `example.com` использует `Strict-Transport-Security: max-age=31536000; includeSubDomains`. Браузер перенаправляет все запросы (включая `blog.example.com`) на HTTPS, игнорируя HTTP. Попытка доступа через HTTP или игнорирование SSL-предупреждений блокируется.
  - Без HSTS пользователь может случайно использовать HTTP, подвергаясь риску MITM-атаки.
- **Рекомендация**:
  - Включите HSTS с директивой `max-age=31536000` для всех HTTPS-сайтов, чтобы обеспечить безопасное соединение.
  - Используйте `includeSubDomains`, если все поддомены поддерживают HTTPS.
  - Рассмотрите `preload` только после тщательного тестирования и регистрации на hstspreload.org.
  - Начинайте с короткого `max-age` (например, 3600 секунд) для тестирования, затем увеличивайте до 31536000 секунд.
- **Осторожно**:
  - HSTS работает только при наличии действующего SSL/TLS-сертификата. Без HTTPS сайт станет недоступным.
  - Неправильная настройка `includeSubDomains` или `preload` может заблокировать доступ к поддоменам или всему сайту на длительный срок (до истечения `max-age`).
  - Тестируйте в **Preview Mode** W3 Total Cache и проверьте HTTPS на всех доменах/поддоменах перед активацией.
  - Убедитесь, что сервер и CDN (например, Cloudflare) поддерживают HSTS и не переопределяют заголовок.

### 5.5. X-Frame-Options
- **Описание**: HTTP-заголовок `X-Frame-Options` контролирует, может ли страница сайта быть встроена в `<iframe>`, `<frame>` или `<object>` на другом сайте, защищая от атак типа clickjacking (когда злоумышленник встраивает ваш сайт в невидимый фрейм для перехвата кликов).
- **Назначение**:
  - Предотвращает встраивание сайта в чужие страницы, защищая пользователей от манипуляций.
  - Обеспечивает безопасность для сайтов с формами ввода (логины, платежи).
- **Технические детали**:
  - Заголовок: `X-Frame-Options`.
  - Применяется к HTTP-ответам для всех страниц сайта.
  - Поддерживается большинством браузеров (Chrome, Firefox, Safari, Edge).
- **Директивы**:
  - **`SameOrigin`** (по умолчанию):
    - Разрешает встраивание страницы в фреймы только на том же домене (например, `example.com` может встраивать свои страницы).
    - **Пример**: `X-Frame-Options: SAMEORIGIN` позволяет `example.com` встраивать свои страницы в `<iframe>`, но блокирует встраивание на `attacker.com`.
    - **Рекомендация**: Используйте для большинства сайтов, где фреймы нужны только внутри домена (например, для виджетов на вашем сайте).
    - **Осторожно**: Убедитесь, что ваш сайт не зависит от встраивания на других доменах.
  - **`Deny`**:
    - Полностью запрещает встраивание страницы в любые фреймы, независимо от домена.
    - **Пример**: `X-Frame-Options: DENY` блокирует `<iframe>` на `example.com` и любых других сайтах.
    - **Рекомендация**: Используйте для сайтов, где фреймы не нужны (например, сайты с формами оплаты, админ-панели).
    - **Осторожно**: Может нарушить функциональность, если ваш сайт использует `<iframe>` для внутреннего контента.
  - **`Allow-From`**:
    - Разрешает встраивание страницы в фреймы на указанных доменах.
    - **Пример**: `X-Frame-Options: ALLOW-FROM https://trusted.com` позволяет встраивание только на `trusted.com`.
    - **Рекомендация**: Используйте в редких случаях, когда ваш сайт должен быть встроен на конкретных доверенных доменах (например, партнёрские виджеты).
    - **Осторожно**: Поддержка ограничена (некоторые браузеры игнорируют); вместо этого используйте Content Security Policy (`frame-ancestors`). Требуется точное указание домена.
- **Пример**:
  - Сайт `example.com` использует `X-Frame-Options: SAMEORIGIN`. Злоумышленник на `attacker.com` пытается встроить страницу логина в `<iframe>`, но браузер блокирует это, предотвращая clickjacking.
  - Без `X-Frame-Options` злоумышленник может перехватить клики по форме логина.
- **Рекомендация**:
  - Включите с директивой `SAMEORIGIN` для большинства WordPress-сайтов, так как она балансирует безопасность и функциональность.
  - Используйте `DENY` для критически важных страниц (например, админ-панель, страницы оплаты).
  - Рассмотрите `ALLOW-FROM` только при необходимости и с осторожностью; лучше используйте CSP (`frame-ancestors`).
- **Осторожно**:
  - Проверьте, не использует ли ваш сайт `<iframe>` для внутреннего контента (например, виджеты, редакторы). `DENY` может их сломать.
  - `ALLOW-FROM` имеет ограниченную поддержку и требует точной настройки домена; ошибки приведут к блокировке.
  - Для большей гибкости используйте Content Security Policy (`frame-ancestors`) вместо или в дополнение к `X-Frame-Options`.

### 5.6. X-XSS-Protection
- **Описание**: HTTP-заголовок `X-XSS-Protection` управляет встроенным механизмом защиты от атак межсайтового скриптинга (XSS) в браузерах, фильтруя потенциально опасные скрипты в HTTP-ответах.
- **Назначение**:
  - Защищает пользователей от XSS-атак, блокируя или очищая вредоносный код, внедрённый в страницы.
  - Устаревший механизм, так как современные браузеры (с 2018 года) используют более продвинутые фильтры XSS и Content Security Policy (CSP).
- **Технические детали**:
  - Заголовок: `X-XSS-Protection`.
  - Применяется к HTTP-ответам страниц, содержащих HTML.
  - Поддерживается в старых версиях Chrome, Safari, IE/Edge; современные браузеры (Chrome 78+, Firefox) игнорируют в пользу CSP.
- **Директивы**:
  - **`0`**:
    - Отключает встроенный XSS-фильтр браузера.
    - **Пример**: `X-XSS-Protection: 0` позволяет странице загружаться без вмешательства фильтра, даже если браузер обнаруживает XSS.
    - **Рекомендация**: Используйте, если вы полностью полагаетесь на Content Security Policy или собственные механизмы защиты от XSS.
    - **Осторожно**: Отключение фильтра увеличивает риск XSS, если CSP не настроен должным образом.
  - **`1`**:
    - Включает XSS-фильтр, который очищает (санирует) потенциально опасный код, позволяя странице загружаться.
    - **Пример**: `X-XSS-Protection: 1` удаляет вредоносный `<script>` из ответа, сохраняя функциональность страницы.
    - **Рекомендация**: Используйте для совместимости со старыми браузерами, если `mode=block` вызывает проблемы.
    - **Осторожно**: Санитация может быть недостаточно надёжной; фильтр иногда пропускает сложные XSS-атаки.
  - **`1; mode=block`** (по умолчанию):
    - Включает XSS-фильтр и полностью блокирует загрузку страницы, если обнаружен вредоносный код.
    - **Пример**: `X-XSS-Protection: 1; mode=block` предотвращает загрузку страницы, если в ответе найден `<script>alert('XSS')</script>`.
    - **Рекомендация**: Используйте для максимальной защиты в старых браузерах, где XSS-фильтр всё ещё активен.
    - **Осторожно**: Может блокировать легитимный контент, если фильтр ошибочно срабатывает (например, на сложных JavaScript-приложениях).
- **Пример**:
  - Сайт `example.com` использует `X-XSS-Protection: 1; mode=block`. Злоумышленник внедряет `<script>alert('XSS')</script>` через параметр URL. Браузер блокирует страницу, защищая пользователя.
  - Без `X-XSS-Protection` или с `0` вредоносный скрипт может выполниться в старых браузерах.
- **Рекомендация**:
  - Включите с директивой `1; mode=block` для совместимости со старыми браузерами (IE, старые версии Chrome/Safari), чтобы минимизировать риск XSS.
  - Для современных браузеров полагайтесь на Content Security Policy (CSP), так как `X-XSS-Protection` устарел и игнорируется.
  - Если ваш сайт использует сложный JavaScript (например, SPA), протестируйте с `1` или `0`, чтобы избежать ложных срабатываний.
- **Осторожно**:
  - `X-XSS-Protection` не заменяет CSP; без CSP сайт остаётся уязвимым к сложным XSS-атакам.
  - Ложные срабатывания фильтра (особенно с `mode=block`) могут блокировать легитимный контент, нарушая функциональность.
  - Тестируйте в **Preview Mode** и используйте инструменты, такие как OWASP ZAP, для проверки защиты от XSS.

### 5.7. X-Content-Type-Options
- **Рекомендация**: Включите для предотвращения MIME-sniffing.
- **Осторожно**: Обязательно для всех сайтов.

### 5.8. HTTP Public Key Pinning (HPKP)
- **Описание**: HTTP Public Key Pinning (HPKP) — это HTTP-заголовок, который позволяет сайту указывать браузерам, какие публичные ключи (или их отпечатки) должны использоваться для проверки SSL/TLS-сертификатов в цепочке доверия. Это защищает от атак типа "человек посередине" (MITM), использующих поддельные сертификаты, выданные скомпрометированными удостоверяющими центрами (CA).
- **Назначение**:
  - Гарантирует, что браузер доверяет только заранее указанным публичным ключам, связанным с сертификатами сайта.
  - Защищает от MITM-атак, когда злоумышленник пытается подменить сертификат.
  - Предоставляет механизм отчётности о сбоях проверки ключей.
- **Технические детали**:
  - Заголовок: `Public-Key-Pins` или `Public-Key-Pins-Report-Only`.
  - Формат: `pin-sha256="<base64-encoded-SPKI-fingerprint>"; max-age=<seconds>; includeSubDomains; report-uri="<URL>"`.
  - `pin-sha256`: Base64-кодированный отпечаток SHA256 публичного ключа (SPKI, Subject Public Key Info) из цепочки сертификатов.
  - `max-age`: Срок действия привязки ключей в секундах.
  - `includeSubDomains`: Применяет HPKP ко всем поддоменам.
  - `report-uri`: URL для отправки отчётов о сбоях проверки.
  - **Статус**: HPKP устарел (удалён из Chrome в 2018 году, Firefox и других браузеров). Заменён механизмами, такими как Certificate Transparency и Expect-CT. Современные браузеры игнорируют заголовок `Public-Key-Pins`.
- **Почему HPKP устарел**:
  - **Высокий риск**: Неправильная настройка (например, истёкший сертификат или неверный отпечаток) может сделать сайт недоступным для пользователей на весь срок `max-age` (до нескольких месяцев).
  - **Сложность**: Требует точного управления цепочкой сертификатов и резервных ключей.
  - **Альтернативы**: Certificate Transparency (проверка логов CA), Expect-CT, и HSTS обеспечивают аналогичную защиту с меньшими рисками.
  - **Ограниченная поддержка**: Современные браузеры (Chrome 67+, Firefox 65+) не поддерживают HPKP, что делает его неэффективным.

- **Поля конфигурации**:
    - **Public Key**
        - **Описание**: Поле для ввода Base64-кодированного отпечатка SHA256 публичного ключа (SPKI) из текущей цепочки сертификатов сайта. Это обязательное поле, определяющее основной ключ, которому браузер должен доверять.
        - **Назначение**: Указывает браузеру, что только сертификаты с этим публичным ключом (или его цепочкой) являются доверенными для сайта.
        - **Технические детали**:
        Формат: `pin-sha256="<base64-encoded-SPKI-fingerprint>"`.
        SPKI-отпечаток генерируется из публичного ключа сертификата (сертификата сайта, промежуточного или корневого CA). Для получения отпечатка используйте инструменты, такие как `openssl`:
        ```bash
      openssl x509 -in certificate.crt -pubkey -noout | openssl pkey -pubin -outform der | openssl dgst -sha256 -binary | base64
        ```
        - **Пример**:
            - Для сайта `example.com` вы генерируете отпечаток текущего сертификата и вводите `dJSG7Jwe3DHkz2ehs7GChd3+EBuL6N5XHr3ZmavWvqc=`. Браузер проверяет, что сертификат сайта содержит этот ключ.
        - **Рекомендация**:
            - Не используйте, так как HPKP устарел и не поддерживается современными браузерами.
            - Если всё же требуется (для старых систем), выберите отпечаток из текущего сертификата или промежуточного CA, чтобы минимизировать риск при смене сертификата.
        - **Осторожно**:
            - Ошибка в отпечатке или смена сертификата без обновления HPKP сделает сайт недоступным.
            - Требуется точное понимание цепочки сертификатов.

    - **Public Key (Backup)**
        - **Описание**: Поле для ввода Base64-кодированного отпечатка SHA256 резервного публичного ключа, который не входит в текущую цепочку сертификатов. Это обязательное поле, служащее для защиты на случай истечения или отзыва основного сертификата.
        - **Назначение**: Обеспечивает резервный ключ, которому браузер может доверять, если основной сертификат становится недействительным.
        - **Технические детали**:
            - Формат: `pin-sha256="<base64-encoded-SPKI-fingerprint>"`.
            - Резервный ключ должен быть из сертификата, не используемого в текущей цепочке (например, из нового сертификата, который вы планируете использовать в будущем).
            - Генерируется аналогично основному ключу с помощью `openssl`.
        - **Пример**:
            - Вы создаёте резервный сертификат и генерируете отпечаток `pin-sha256="pL1+qb9HTMRZJmuC/bB KnudKnRpdFhYh7o5+jygKb4="`. Если основной сертификат отзывается, браузер доверяет резервному ключу.
        - **Рекомендация**:
            - Не используйте из-за устаревания HPKP.
            - Если необходимо, подготовьте резервный ключ заранее, используя сертификат от другого CA или новый ключ, чтобы обеспечить гибкость при смене сертификатов.
        - **Осторожно**:
            - Без резервного ключа смена сертификата приведёт к блокировке сайта.
            - Храните резервный сертификат в безопасном месте; его компрометация снижает безопасность.

### 5.9. Extra Parameters
  - **Описание**: Поле для указания дополнительных параметров заголовка HPKP, таких как срок действия (`max-age`) и применение к поддоменам (`includeSubDomains`).
  - **Назначение**: Определяет, как долго браузер хранит привязку ключей и распространяется ли она на поддомены.
  - **Технические детали**:
    - Формат по умолчанию: `max-age=EXPIRES_SECONDS`.
    - `max-age`: Срок действия HPKP в секундах (например, 2592000 секунд = 30 дней).
    - `includeSubDomains`: Если указано, HPKP применяется ко всем поддоменам (например, `blog.example.com`).
    - Пример: `max-age=2592000; includeSubDomains`.
  - **Пример**:
    - Указав `max-age=2592000; includeSubDomains`, вы заставляете браузер хранить привязку ключей для `example.com` и всех поддоменов на 30 дней.
  - **Рекомендация**:
    - Не используйте HPKP.
    - Если требуется, установите короткий `max-age` (например, 3600 секунд) для тестирования, затем увеличьте до 2592000 секунд. Избегайте `includeSubDomains`, если поддомены не имеют SSL.
  - **Осторожно**:
    - Долгий `max-age` (например, 31536000 секунд) увеличивает риск блокировки сайта при ошибке.
    - `includeSubDomains` требует HTTPS на всех поддоменах; иначе поддомены станут недоступными.

### 5.10. Report URL
  - **Описание**: Опциональное поле для указания URL, на который браузеры отправляют отчёты о сбоях проверки HPKP (например, если сертификат не соответствует указанным ключам).
  - **Назначение**: Позволяет администратору сайта отслеживать попытки MITM-атак или ошибки конфигурации.
  - **Технические детали**:
    - Формат: `report-uri="<URL>"`.
    - Браузер отправляет POST-запрос с JSON-телом, содержащим детали сбоя (например, домен, отпечаток, дата).
    - Пример: `report-uri="https://example.com/hpkp-report"`.
  - **Пример**:
    - Вы указываете `report-uri="https://example.com/hpkp-report"`. Если браузер обнаруживает несоответствие ключа, он отправляет отчёт, который вы можете проанализировать для выявления атак.
  - **Рекомендация**:
    - Не используйте из-за устаревания HPKP.
    - Если необходимо, настройте защищённый endpoint (HTTPS) для получения отчётов и включите `Report Mode Only` для тестирования.
  - **Осторожно**:
    - Без `Report Mode Only` сбои приводят к блокировке сайта, а не только к отчёту.
    - Endpoint должен быть доступен и защищён; иначе отчёты не дойдут.

### 5.11. Report Mode Only
  - **Описание**: Опция, определяющая, будет ли HPKP принудительно применяться или только отправлять отчёты о сбоях без блокировки.
  - **Назначение**: Позволяет тестировать HPKP, не рискуя заблокировать сайт для пользователей.
  - **Технические детали**:
    - Значение: `No = Enforce HPKP` (по умолчанию) или включение режима отчётов.
    - Если включено, используется заголовок `Public-Key-Pins-Report-Only`, и браузер только отправляет отчёты, не блокируя доступ.
    - Если отключено, используется `Public-Key-Pins`, и сбои проверки блокируют сайт.
  - **Пример**:
    - С `Report Mode Only` включённым и `report-uri="https://example.com/hpkp-report"` браузер отправляет отчёт о несоответствии ключа, но позволяет загрузить сайт.
    - Без `Report Mode Only` сайт блокируется при сбое.
  - **Рекомендация**:
    - Не используйте HPKP.
    - Если необходимо, всегда включайте `Report Mode Only` для тестирования, чтобы избежать блокировки сайта.
  - **Осторожно**:
    - Отключение `Report Mode Only` (принудительное применение) опасно; ошибки конфигурации сделают сайт недоступным.
    - Тестируйте с коротким `max-age` и включённым `Report Mode Only`.


### 5.12. Referrer Policy
- **Описание**: HTTP-заголовок `Referrer-Policy` управляет содержимым заголовка `Referer`, отправляемого браузером при переходе по внешним ссылкам, загрузке ресурсов или отправке форм. Он определяет, какая информация о странице-источнике (URL) передаётся в запросах.
- **Назначение**:
  - Защищает конфиденциальность пользователей, ограничивая передачу чувствительных данных (например, параметров URL) на сторонние сайты.
  - Балансирует между безопасностью и функциональностью аналитики, которая часто использует `Referer` для отслеживания источников трафика.
- **Технические детали**:
  - Заголовок: `Referrer-Policy`.
  - Применяется к HTTP-запросам, инициированным ссылками (`<a>`), формами, скриптами, изображениями и другими ресурсами.
  - Поддерживается современными браузерами (Chrome, Firefox, Safari, Edge).
- **Директивы**:
  - **`Not Set`**:
    - Отсутствие заголовка `Referrer-Policy`. Браузер использует поведение по умолчанию (обычно `strict-origin-when-cross-origin` в современных браузерах).
    - **Пример**: Переход с `https://example.com/page?user=123` на `http://external.com` отправляет полный URL в `Referer`, если браузер настроен на это.
    - **Рекомендация**: Избегайте, так как поведение непредсказуемо и зависит от браузера.
    - **Осторожно**: Может привести к утечке чувствительных данных.
  - **`no-referrer`**:
    - Полностью отключает отправку заголовка `Referer` во всех запросах.
    - **Пример**: Переход с `https://example.com/page?user=123` на любой сайт не отправляет `Referer`.
    - **Рекомендация**: Используйте для сайтов с высокой конфиденциальностью (например, медицинские порталы), где утечка URL недопустима.
    - **Осторожно**: Нарушает аналитику, так как сторонние сайты не видят источник трафика.
  - **`no-referrer-when-downgrade`** (по умолчанию):
    - Отправляет полный `Referer` при переходе с HTTPS на HTTPS, но не отправляет ничего при переходе с HTTPS на HTTP (downgrade).
    - **Пример**: С `https://example.com/page?user=123` на `https://external.com` отправляется полный URL; на `http://external.com` — ничего.
    - **Рекомендация**: Используйте для большинства сайтов, так как это баланс между безопасностью и аналитикой.
    - **Осторожно**: Чувствительные параметры URL всё ещё могут передаваться на HTTPS-сайты.
  - **`same-origin`**:
    - Отправляет полный `Referer` только для запросов в пределах того же домена; для сторонних сайтов `Referer` не отправляется.
    - **Пример**: С `https://example.com/page` на `https://example.com/other` отправляется полный URL; на `https://external.com` — ничего.
    - **Рекомендация**: Подходит для сайтов, где внутренние переходы важны для аналитики, но внешние утечки нежелательны.
    - **Осторожно**: Ограничивает внешнюю аналитику.
  - **`origin`**:
    - Отправляет только происхождение (домен, протокол, порт) без пути или параметров.
    - **Пример**: С `https://example.com/page?user=123` отправляется `https://example.com`.
    - **Рекомендация**: Используйте, если аналитика требует только домен источника, а путь/параметры нужно скрыть.
    - **Осторожно**: Может быть недостаточно для детальной аналитики.
  - **`strict-origin`**:
    - Отправляет происхождение только для HTTPS-запросов; ничего не отправляет для HTTP.
    - **Пример**: С `https://example.com/page?user=123` на `https://external.com` отправляется `https://example.com`; на `http://external.com` — ничего.
    - **Рекомендация**: Подходит для HTTPS-сайтов, где безопасность приоритетна.
    - **Осторожно**: Ограничивает аналитику для HTTP-сайтов.
  - **`origin-when-cross-origin`**:
    - Отправляет полный `Referer` для запросов внутри домена; только происхождение для сторонних сайтов.
    - **Пример**: С `https://example.com/page?user=123` на `https://example.com/other` отправляется полный URL; на `https://external.com` — `https://example.com`.
    - **Рекомендация**: Хороший компромисс для сайтов с внутренними и внешними ссылками.
    - **Осторожно**: Упрощённый `Referer` может ограничить аналитику.
  - **`strict-origin-when-cross-origin`**:
    - Отправляет полный `Referer` внутри домена; происхождение для сторонних HTTPS-сайтов; ничего для HTTP.
    - **Пример**: С `https://example.com/page?user=123` на `https://example.com/other` — полный URL; на `https://external.com` — `https://example.com`; на `http://external.com` — ничего.
    - **Рекомендация**: Современный стандарт, подходящий для HTTPS-сайтов с аналитикой.
    - **Осторожно**: Ограничивает данные для HTTP-сайтов.
  - **`unsafe-url`**:
    - Отправляет полный `Referer`, включая путь и параметры, во всех случаях.
    - **Пример**: С `https://example.com/page?user=123` отправляется полный URL на любой сайт.
    - **Рекомендация**: Избегайте, так как это небезопасно и может утечь чувствительные данные.
    - **Осторожно**: Используйте только для отладки или если аналитика критически важна.
- **Пример**:
  - Сайт `example.com` использует `no-referrer-when-downgrade`. Переход с `https://example.com/login?user=123` на `https://analytics.com` отправляет полный URL в `Referer`, но на `http://old-site.com` ничего не отправляется, защищая параметры.
  - С `no-referrer` аналитика не получает никаких данных о переходах.
- **Рекомендация**:
  - Установите `no-referrer-when-downgrade` для большинства WordPress-сайтов, чтобы сбалансировать безопасность и аналитику.
  - Используйте `no-referrer` для сайтов с высокой конфиденциальностью (например, финансовые платформы).
  - Рассмотрите `strict-origin-when-cross-origin` для современных HTTPS-сайтов.
- **Осторожно**:
  - Строгие политики (`no-referrer`, `same-origin`) могут нарушить работу аналитики (Google Analytics, Yandex.Metrika).
  - Проверьте, как политика влияет на сторонние сервисы (например, платёжные шлюзы).
  - Тестируйте в **Preview Mode** и используйте Chrome DevTools (вкладка Network) для проверки `Referer`.

### 5.13. Content Security Policy (CSP)
- **Описание**: HTTP-заголовок `Content-Security-Policy` ограничивает источники, из которых браузер может загружать ресурсы (скрипты, стили, изображения и т.д.), снижая риск атак межсайтового скриптинга (XSS) и других инъекций вредоносного кода.
- **Назначение**:
    - Предотвращает выполнение несанкционированных скриптов или загрузку ресурсов с ненадёжных источников.
    - Защищает от XSS, инъекций через параметры URL или пользовательский контент.
    - Позволяет отслеживать нарушения политики через отчёты.
- **Технические детали**:
    - Заголовок: `Content-Security-Policy`.
    - Формат: `directive source; directive source; ...`.
    - Поддерживаемые значения: `'self'` (текущий домен), `'none'` (запрет), `'unsafe-inline'` (разрешить инлайн-ресурсы), `'unsafe-eval'` (разрешить `eval`), `*.domain.com` (поддомены), конкретные URL.
    - Поддерживается всеми современными браузерами.
- **Поля конфигурации**:
    - **`report-uri`**:
        - Указывает URL для отправки отчётов о нарушениях CSP (JSON через POST).
        - **Пример**: `report-uri https://example.com/csp-report` отправляет отчёты о попытках загрузки скрипта с запрещённого домена.
        - **Рекомендация**: Настройте защищённый endpoint и используйте для отладки.
        - **Осторожно**: Требует HTTPS и доступного сервера для обработки отчётов.
    - **`report-to`**:
        - Определяет группу конечных точек для отчётов, заданную в заголовках `Report-To` или `Reporting-Endpoints`.
        - **Пример**: `report-to csp-endpoint` ссылается на группу, настроенную в `.htaccess`.
        - **Рекомендация**: Используйте для современных браузеров, поддерживающих `Report-To`.
        - **Осторожно**: Требует ручной настройки заголовков через `.htaccess` или сервер.
    - **`base-uri`**:
        - Ограничивает URL для элемента `<base>`.
        - **Пример**: `base-uri 'self' *.example.com` разрешает только собственный домен и поддомены.
        - **Рекомендация**: Установите `'self'` для большинства сайтов.
        - **Осторожно**: Неправильная настройка может нарушить относительные ссылки.
    - **`connect-src`**:
        - Ограничивает источники для `XMLHttpRequest`, WebSocket, EventSource.
        - **Пример**: `connect-src 'self' api.example.com` разрешает AJAX-запросы только к своему домену и API.
        - **Рекомендация**: Укажите доверенные API и сервисы (например, аналитика).
        - **Осторожно**: Слишком строгие ограничения ломают AJAX.
    - **`font-src`**:
        - Ограничивает источники для веб-шрифтов.
        - **Пример**: `font-src 'self' fonts.google.com` разрешает шрифты с Google Fonts.
        - **Рекомендация**: Укажите `'self'` и CDN шрифтов.
        - **Осторожно**: Проверьте источники шрифтов в теме WordPress.
    - **`frame-src`**:
        - Ограничивает источники для `<iframe>` и `<frame>`.
        - **Пример**: `frame-src 'self' youtube.com` разрешает видео с YouTube.
        - **Рекомендация**: Укажите доверенные сервисы (видео, виджеты).
        - **Осторожно**: Строгие ограничения ломают виджеты.
    - **`img-src`**:
        - Ограничивает источники для изображений и favicon.
        - **Пример**: `img-src 'self' cdn.example.com` разрешает изображения с CDN.
        - **Рекомендация**: Укажите `'self'` и CDN.
        - **Осторожно**: Проверьте источники изображений в плагинах.
    - **`media-src`**:
        - Ограничивает источники для `<audio>` и `<video>`.
        - **Пример**: `media-src 'self' media.example.com` разрешает медиа с сервера.
        - **Рекомендация**: Укажите доверенные медиа-хостинги.
        - **Осторожно**: Строгие настройки могут блокировать видео.
    - **`object-src`**:
        - Ограничивает источники для `<object>`, `<embed>`, `<applet>` (Flash, плагины).
        - **Пример**: `object-src 'none'` запрещает плагины.
        - **Рекомендация**: Установите `'none'`, так как Flash устарел.
        - **Осторожно**: Убедитесь, что сайт не использует старые плагины.
    - **`script-src`**:
        - Ограничивает источники для JavaScript.
        - **Пример**: `script-src 'self' 'unsafe-inline' cdn.example.com` разрешает скрипты с CDN и инлайн-скрипты.
        - **Рекомендация**: Избегайте `'unsafe-inline'`; используйте nonce или хэши.
        - **Осторожно**: Строгие настройки могут ломать плагины WordPress.
    - **`style-src`**:
        - Ограничивает источники для CSS.
        - **Пример**: `style-src 'self' 'unsafe-inline'` разрешает инлайн-стили.
        - **Рекомендация**: Используйте nonce вместо `'unsafe-inline'`.
        - **Осторожно**: Проверьте инлайн-стили в темах.
    - **`form-action`**:
        - Ограничивает URL для отправки форм.
        - **Пример**: `form-action 'self'` разрешает отправку форм только на свой домен.
        - **Рекомендация**: Установите `'self'` для безопасности.
        - **Осторожно**: Проверьте формы в плагинах (например, Contact Form 7).
    - **`frame-ancestors`**:
        - Ограничивает домены, которые могут встраивать сайт через `<iframe>`, `<frame>`, `<object>`.
        - **Пример**: `frame-ancestors 'none'` запрещает встраивание.
        - **Рекомендация**: Установите `'none'` или доверенные домены.
        - **Осторожно**: Заменяет `X-Frame-Options` в современных браузерах.
    - **`plugin-types`**:
        - Ограничивает типы плагинов (например, Flash).
        - **Пример**: `plugin-types application/x-shockwave-flash` разрешает Flash.
        - **Рекомендация**: Установите `'none'`, так как плагины устарели.
        - **Осторожно**: Убедитесь, что сайт не использует Flash.
    - **`sandbox`**:
        - Применяет ограничения, аналогичные `<iframe sandbox>`, например, запрет скриптов или всплывающих окон.
        - **Пример**: `sandbox allow-popups` разрешает всплывающие окна.
        - **Рекомендация**: Используйте с осторожностью; подходит для изолированных страниц.
        - **Осторожно**: Может нарушить функциональность сайта.
    - **`child-src`**:
        - Ограничивает источники для веб-воркеров и `<iframe>`.
        - **Пример**: `child-src 'self'` разрешает воркеры с собственного домена.
        - **Рекомендация**: Укажите `'self'` и доверенные домены.
        - **Осторожно**: Проверьте использование воркеров в плагинах.
    - **`manifest-src`**:
        - Ограничивает источники для манифестов PWA.
        - **Пример**: `manifest-src 'self'` разрешает манифест с домена.
        - **Рекомендация**: Установите `'self'` для PWA.
        - **Осторожно**: Проверьте настройки PWA.
    - **`script-src-elem`**, **`script-src-attr`**, **`style-src-elem`**, **`style-src-attr`**:
        - Более точные директивы для скриптов и стилей (элементы vs атрибуты).
        - **Пример**: `script-src-elem 'self'` ограничивает `<script>` элементы.
        - **Рекомендация**: Используйте для строгого контроля; требует тестирования.
        - **Осторожно**: Может быть сложным для WordPress.
    - **`worker-src`**:
        - Ограничивает источники для воркеров (Worker, SharedWorker, ServiceWorker).
        - **Пример**: `worker-src 'self'` разрешает воркеры с домена.
        - **Рекомендация**: Установите `'self'`.
        - **Осторожно**: Проверьте воркеры в JavaScript.
    - **`default-src`**:
        - Задаёт значения по умолчанию для всех `-src` директив, если они не указаны.
        - **Пример**: `default-src 'self'` применяет `'self'` ко всем ресурсам.
        - **Рекомендация**: Установите `'self'` как базовую защиту.
        - **Осторожно**: Слишком строгие настройки ломают сайт.
- **Пример**:
    - Настройка: `default-src 'self'; script-src 'self' cdn.example.com; img-src 'self' images.example.com; report-uri https://example.com/csp-report`.
    - Результат: Скрипты загружаются только с `example.com` и `cdn.example.com`, изображения — с `example.com` и `images.example.com`. Нарушения отправляются на `https://example.com/csp-report`.
- **Рекомендация**:
    - Настройте минимальный CSP: `default-src 'self'; script-src 'self'; style-src 'self'`.
    - Постепенно добавляйте доверенные источники (CDN, аналитика).
    - Используйте `report-uri` и CSPRO для тестирования.
    - Избегайте `'unsafe-inline'` и `'unsafe-eval'`; используйте nonce или хэши.
- **Осторожно**:
    - Неправильная настройка может заблокировать ресурсы, ломая сайт.
    - WordPress-плагины и темы часто используют инлайн-скрипты/стили, требуя `'unsafe-inline'`.
    - Тестируйте в **Preview Mode** и используйте Chrome DevTools (Console) для отладки.

### 5.14. Content Security Policy Report Only(CSPRO)

- **Описание**: HTTP-заголовок `Content-Security-Policy-Report-Only` позволяет тестировать CSP-политики, отправляя отчёты о нарушениях без их принудительного применения. Это помогает отлаживать политики перед активацией.
- **Назначение**:
    - Обнаруживает потенциальные проблемы в CSP без блокировки ресурсов.
    - Собирает данные о попытках XSS или других атак.
- **Технические детали**:
    - Заголовок: `Content-Security-Policy-Report-Only`.
    - Формат аналогичен CSP, но не блокирует ресурсы.
    - Используется отдельно от `Content-Security-Policy`.
- **Поля конфигурации**: Аналогичны CSP (см. выше):
    - **`report-uri`**, **`report-to`**, **`base-uri`**, **`connect-src`**, **`font-src`**, **`frame-src`**, **`img-src`**, **`media-src`**, **`object-src`**, **`script-src`**, **`style-src`**, **`form-action`**, **`frame-ancestors`**, **`plugin-types`**, **`sandbox`**, **`child-src`**, **`manifest-src`**, **`script-src-elem`**, **`script-src-attr`**, **`style-src-elem`**, **`style-src-attr`**, **`worker-src`**, **`default-src`**:
        - Работают так же, как в CSP, но только для отчётов.
        - **Пример**: `report-uri https://example.com/csp-report; default-src 'self'` отправляет отчёт, если ресурс загружается не с `example.com`, но не блокирует его.
        - **Рекомендация**: Настройте `report-uri` и начните с широких политик (например, `default-src *`).
        - **Осторожно**: Отчёты требуют HTTPS-endpoint и могут генерировать большой объём данных.
- **Пример**:
    - Настройка: `Content-Security-Policy-Report-Only: default-src 'self'; report-uri https://example.com/csp-report`.
    - Результат: Попытка загрузки скрипта с `attacker.com` отправляет отчёт, но скрипт загружается.
- **Рекомендация**:
    - Включите CSPRO перед активацией CSP для тестирования политик.
    - Используйте `report-uri` для анализа нарушений.
    - Постепенно ужесточайте политики на основе отчётов.
- **Осторожно**:
    - Без `report-uri` или `report-to` отчёты не отправляются.
    - Настройте сервер для обработки отчётов; большой объём может нагружать сервер.
    - Тестируйте в **Preview Mode** и проверяйте отчёты.

### 5.15. Feature-Policy / Permissions-Policy

- **Описание**: HTTP-заголовок `Permissions-Policy` (ранее `Feature-Policy`) контролирует, какие функции браузера (например, камера, геолокация, автоплей) могут использоваться сайтом или встроенными фреймами.
- **Назначение**:
    - Ограничивает доступ к чувствительным API, снижая риск злоупотребления (например, несанкционированный доступ к камере).
    - Повышает безопасность, отключая ненужные функции.
- **Технические детали**:
    - Заголовок: `Permissions-Policy`.
    - Формат: `feature <allowlist>`, где `<allowlist>` — `*`, `'self'`, `'none'`, или домены (например, `*.example.com`).
    - Поддерживается современными браузерами (Chrome, Edge, Firefox с ограничениями).
- **Директивы**:
    - **`accelerometer`**, **`ambient-light-sensor`**, **`gyroscope`**, **`magnetometer`**:
        - Контролируют доступ к сенсорам устройства.
        - **Пример**: `accelerometer 'none'` отключает акселерометр.
        - **Рекомендация**: Установите `'none'`, если сенсоры не нужны.
        - **Осторожно**: Убедитесь, что сайт не использует сенсоры (например, для игр).
    - **`autoplay`**:
        - Контролирует автоплей медиа.
        - **Пример**: `autoplay 'self'` разрешает автоплей только для сайта.
        - **Рекомендация**: Установите `'self'` или `'none'` для контроля медиа.
        - **Осторожно**: Строгие настройки могут блокировать видео.
    - **`battery`**:
        - Контролирует доступ к Battery Status API.
        - **Пример**: `battery 'none'` отключает API.
        - **Рекомендация**: Установите `'none'`, так как API устарел.
        - **Осторожно**: Редко используется, но проверьте плагины.
    - **`camera`**, **`microphone`**:
        - Контролируют доступ к камере и микрофону.
        - **Пример**: `camera 'none'` отключает камеру.
        - **Рекомендация**: Установите `'none'`, если не нужны (например, для блогов).
        - **Осторожно**: Проверьте видеочаты или плагины.
    - **`display-capture`**, **`screen-wake-lock`**:
        - Контролируют захват экрана и блокировку выключения экрана.
        - **Пример**: `display-capture 'none'` отключает захват.
        - **Рекомендация**: Установите `'none'` для большинства сайтов.
        - **Осторожно**: Проверьте приложения (например, презентации).
    - **`document-domain`**:
        - Контролирует использование `document.domain`.
        - **Пример**: `document-domain 'none'` запрещает изменение.
        - **Рекомендация**: Установите `'none'` для безопасности.
        - **Осторожно**: Редко используется в современных сайтах.
    - **`encrypted-media`**, **`midi`**, **`payment`**, **`usb`**, **`vr`**, **`xr-spatial-tracking`**:
        - Контролируют специфические API (медиа, MIDI, платежи, USB, VR).
        - **Пример**: `payment 'self'` разрешает платежи только для сайта.
        - **Рекомендация**: Установите `'none'` или `'self'` для нужных функций.
        - **Осторожно**: Проверьте плагины (например, WooCommerce).
    - **`fullscreen`**, **`picture-in-picture`**:
        - Контролируют полноэкранный режим и режим "картинка в картинке".
        - **Пример**: `fullscreen 'self'` разрешает полноэкранный режим.
        - **Рекомендация**: Установите `'self'` для видео-сайтов.
        - **Осторожно**: Строгие настройки блокируют видео.
    - **`geolocation`**:
        - Контролирует доступ к геолокации.
        - **Пример**: `geolocation 'none'` отключает геолокацию.
        - **Рекомендация**: Установите `'none'`, если не нужна.
        - **Осторожно**: Проверьте карты или плагины.
    - **`gamepad`**, **`vibrate`**:
        - Контролируют геймпады и вибрацию.
        - **Пример**: `vibrate 'none'` отключает вибрацию.
        - **Рекомендация**: Установите `'none'` для большинства сайтов.
        - **Осторожно**: Проверьте игровые плагины.
    - **`layout-animations`**, **`legacy-image-formats`**, **`oversized-images`**, **`unoptimized-images`**, **`unsized-media`**:
        - Контролируют анимации и форматы изображений.
        - **Пример**: `oversized-images 'none'` ограничивает большие изображения.
        - **Рекомендация**: Установите `'self'` или экспериментируйте.
        - **Осторожно**: Может повлиять на рендеринг.
    - **`publickey-credentials-get`**, **`web-share`**:
        - Контролируют доступ к Web Authentication и Web Share API.
        - **Пример**: `web-share 'self'` разрешает шаринг.
        - **Рекомендация**: Установите `'self'` для нужных функций.
        - **Осторожно**: Проверьте социальные плагины.
    - **`sync-xhr`**, **`execution-while-not-rendered`**, **`execution-while-out-of-viewport`**:
        - Контролируют синхронные запросы и выполнение скриптов.
        - **Пример**: `sync-xhr 'none'` запрещает синхронные XHR.
        - **Рекомендация**: Установите `'none'` для оптимизации.
        - **Осторожно**: Может сломать старые скрипты.
- **Пример**:
    - Настройка: `Permissions-Policy: camera='none', microphone='none', geolocation='none', fullscreen='self'`.
    - Результат: Камера, микрофон и геолокация отключены; полноэкранный режим разрешён только для сайта.
- **Рекомендация**:
    - Установите `'none'` для ненужных функций (например, `camera`, `microphone`, `geolocation`).
    - Разрешите `'self'` для необходимых функций (например, `fullscreen`, `payment`).
    - Тестируйте в **Preview Mode** и используйте Chrome DevTools для проверки.
- **Осторожно**:
    - Строгие настройки могут сломать плагины или функции (например, видеочаты, карты).
    - Некоторые директивы (например, `vr`) имеют ограниченную поддержку.
    - Проверьте совместимость с WordPress-плагинами.

---

## Рекомендации

| Настройка | Рекомендация |
| --- | --- |
| Browser Cache: Enable | Включить |
| Set Last-Modified Header | Включить |
| Set Expires Header | Включить |
| Set Cache Control Header | Включить |
| Set Entity Tag (ETag) | Включить (отключить при высокой нагрузке) |
| Set W3 Total Cache Header | Включить для отладки |
| Enable HTTP (Gzip) Compression | Включить |
| Enable HTTP (Brotli) Compression | Включить, если поддерживается |
| Prevent Caching of Objects After Settings Change | Включить |
| Remove Query Strings from Static Resources | Включить при проблемах с прокси |
| Don't Set Cookies for Static Files | Включить |
| Do Not Process 404 Errors | Включить |
| Rewrite URL Structure of Objects | Включить при необходимости |
| CSS & JS: Expires Lifetime | 31536000 секунд |
| HTML & XML: Expires Lifetime | 3600–7200 секунд |
| Media & Other Files: Expires Lifetime | 31536000 секунд |
| Security Headers: HSTS, X-Frame, XSS, Content-Type | Включить |
| Security Headers: HPKP | Не использовать |
| CSP | Настроить с осторожностью |
| Feature-Policy | Ограничить ненужные функции |

---

## Примеры использования

- **Блог на shared-хостинге**:
    - Включите **Browser Cache**, Gzip, заголовки `Expires` и `Cache-Control`.
    - Установите **Expires Lifetime**: 31536000 секунд для CSS/JS/медиа, 3600 секунд для HTML.
    - Включите **HSTS** и **X-Frame-Options**.
    - Результат: Ускорение загрузки на 100–300 мс, защита от XSS.

- **WooCommerce на VPS**:
    - Включите **Browser Cache**, Brotli, `Prevent Caching of Objects`.
    - Настройте **CSP** с `script-src 'self'`.
    - Установите **Expires Lifetime**: 31536000 секунд для медиа, 7200 секунд для HTML.
    - Результат: Ускорение магазина на 20–50%, снижение трафика.

- **Новостной сайт на выделенном сервере**:
    - Включите все заголовки, Brotli, **Feature-Policy** с `'none'` для `camera`.
    - Используйте **CSP Report Only** для тестирования.
    - Результат: Быстрая загрузка медиа, защита от атак.

---

### Дополнительные советы

- **CDN**: Синхронизируйте настройки с Cloudflare/KeyCDN.
- **Мониторинг**: Используйте Chrome DevTools, GTmetrix для проверки кэширования.
- **Совместимость**: Отключите дублирующие заголовки от других плагинов (Autoptimize).
- **CSP**: Тестируйте с **CSP Report Only** перед активацией.
- **Сервер**: Убедитесь, что Apache/Nginx поддерживают Gzip/Brotli.
